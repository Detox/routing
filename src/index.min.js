/*
 0BSD
*/
(function(){function p(q,p,x,C,A,y){function n(b,a){var e=this;null==a&&(a=10);if(!(this instanceof n))return new n(b,a);y.call(this);this.c=h();this.h=h();this.f=h();this.j=h();this.i=h();this.m=h();this.a=C(D,E,F,a).on("activity",function(c,a){e.fire("activity",c,a)}).on("create_request",function(c,a,l){if(!e.b){var f=m([c,a]);if(!e.c.has(f)){var d=q.Encryptor(!1,b);try{d.put_handshake_message(l)}catch(k){return}e.a.create_response(c,a,d.get_handshake_message());e.a.confirm_incoming_segment_established(c,
a);e.j.set(f,A.Multiplexer(u,e.g));e.i.set(f,A.Demultiplexer(u,e.g));d.ready()&&(a=d.get_rewrapper_keys().map(q.Rewrapper),l=h(),l.set(c,d),d=h(),d.set(c,a),e.c.set(f,l),e.h.set(f,d),e.f.set(f,c))}}}).on("send",function(a,f){e.fire("send",a,f)}).on("data",function(a,f,l,b,d){if(!e.b){var c=m([a,f]);var g=e.f.get(c);z(l,g)&&(l=e.i.get(c))&&(l.feed(d),l.have_more_data()&&(d=l.get_data(),e.fire("data",a,f,b,d)))}}).on("encrypt",function(a){var c;if(!e.b){var b=a.address;var g=a.segment_id;var d=a.target_address;
var k=a.plaintext;b=m([b,g]);(d=null!=(c=e.c.get(b))?c.get(d):void 0)&&d.ready()&&(a.ciphertext=d.encrypt(k))}}).on("decrypt",function(a){var b;if(!e.b){var c=a.address;var g=a.segment_id;var d=a.target_address;var k=a.ciphertext;c=m([c,g]);if((g=null!=(b=e.c.get(c))?b.get(d):void 0)&&g.ready())try{a.plaintext=g.decrypt(k)}catch(G){g.destroy(),e.c.get(c)["delete"](d)}}}).on("wrap",function(a){var b,c;if(!e.b){var g=a.address;var d=a.segment_id;var k=a.target_address;var h=a.unwrapped;g=m([g,d]);(k=
null!=(b=e.h.get(g))?null!=(c=b.get(k))?c[0]:void 0:void 0)&&(a.wrapped=k.wrap(h))}}).on("unwrap",function(a){var b,c;if(!e.b){var g=a.address;var d=a.segment_id;var k=a.target_address;var h=a.wrapped;g=m([g,d]);(k=null!=(b=e.h.get(g))?null!=(c=b.get(k))?c[1]:void 0:void 0)&&(a.unwrapped=k.unwrap(h))}});this.g=this.a.get_max_command_data_length()}var z=x.are_arrays_equal;var m=x.concat_arrays;var h=x.ArrayMap;var u=p.MAX_DATA_SIZE;n.prototype={process_packet:function(b,a){this.b||this.a.process_packet(b,
a)},construct_routing_path:function(b){var a=this;if(this.b)return Promise.reject();b=b.slice();return new Promise(function(e,c){function f(c,g,l){function h(){function c(b,e,f){if(z(d,b)&&z(r,e))if(a.a.off("extend_response",c),clearTimeout(y),f.length){try{v.put_handshake_message(f)}catch(I){t();return}v.ready()?(n.set(m,v.get_rewrapper_keys().map(q.Rewrapper)),a.a.confirm_extended_path(d,r),h()):t()}else t()}var f;b.length?(a.a.on("extend_response",c),m=b.shift(),(f=q.convert_public_key(m))?(v=
q.Encryptor(!0,f),k.set(m,v),y=setTimeout(function(){a.a.off("extend_response",c);t()},1E3*B),a.a.extend_request(d,r,m,v.get_handshake_message())):t()):(a.m.set(w,[d,r]),e(r))}var m,v,y;if(z(d,c)&&z(r,g)){clearTimeout(x);a.a.off("create_response",f);try{p.put_handshake_message(l)}catch(H){t();return}p.ready()?(n.set(d,p.get_rewrapper_keys().map(q.Rewrapper)),a.a.confirm_outgoing_segment_established(d,r),a.j.set(w,A.Multiplexer(u,a.g)),a.i.set(w,A.Demultiplexer(u,a.g)),h()):t()}}var l;var g=b[b.length-
1];var d=b.shift();var k=h();var n=h();var t=function(){a.l(d,r);c("Routing path creation failed")};if(l=q.convert_public_key(d)){var p=q.Encryptor(!0,l);k.set(d,p);a.a.on("create_response",f);var x=setTimeout(function(){a.a.off("create_response",f);t()},1E3*B);var r=a.a.create_request(d,p.get_handshake_message());var w=m([d,r]);a.c.set(w,k);a.h.set(w,n);a.f.set(w,g)}else t()})},destroy_routing_path:function(b,a){this.l(b,a)},get_max_packet_data_size:function(){return this.g},send_data:function(b,
a,e,c){if(!(this.b||c.length>u)){var f=m([b,a]);var h=this.f.get(f);if(f=this.j.get(f))for(f.feed(c);f.have_more_blocks();)c=f.get_block(),this.a.data(b,a,h,e,c)}},destroy:function(){var b=this;this.b||(this.b=!0,this.m.forEach(function(a){b.l(a[0],a[1])}))},l:function(b,a){b=m([b,a]);if(a=this.c.get(b))a.forEach(function(a){a.destroy()}),this.c["delete"](b),this.h["delete"](b),this.f["delete"](b),this.j["delete"](b),this.i["delete"](b),this.m["delete"](b)}};n.prototype=Object.assign(Object.create(y.prototype),
n.prototype);Object.defineProperty(n.prototype,"constructor",{value:n});return{ready:q.ready,Router:n,MAX_DATA_SIZE:u}}var E=32;var F=16;var B=10;var D=509;"function"===typeof define&&define.amd?define("@detox/crypto @detox/transport @detox/utils ronion fixed-size-multiplexer async-eventer".split(" "),p):"object"===typeof exports?module.exports=p(require("@detox/crypto"),require("@detox/transport"),require("@detox/utils"),require("ronion"),require("fixed-size-multiplexer"),require("async-eventer")):
this.detox_transport=p(this.detox_crypto,this.detox_transport,this.detox_utils,this.ronion,this.fixed_size_multiplexer,this.async_eventer)}).call(this);