/*
 0BSD
*/
(function(){function p(q,p,t,D,z,B){function h(b,a,u){var c=this;null==a&&(a=10);null==u&&(u=10);if(!(this instanceof h))return new h(b,a,u);B.call(this);this.o=u;this.c=k();this.h=k();this.f=k();this.j=k();this.i=k();this.m=k();this.a=D(E,F,G,a);this.g=this.a.get_max_command_data_length();this.a.on("activity",function(d,a){c.fire("activity",d,a)}).on("create_request",function(d,a,m){if(!c.b){var e=l([d,a]);if(!c.c.has(e)){var f=q.Encryptor(!1,b);try{f.put_handshake_message(m)}catch(g){return}c.a.create_response(d,
a,f.get_handshake_message());c.a.confirm_incoming_segment_established(d,a);c.j.set(e,z.Multiplexer(v,c.g));c.i.set(e,z.Demultiplexer(v,c.g));f.ready()&&(a=f.get_rewrapper_keys().map(q.Rewrapper),m=k(),m.set(d,f),f=k(),f.set(d,a),c.c.set(e,m),c.h.set(e,f),c.f.set(e,d))}}}).on("send",function(a,b){c.fire("send",a,b)}).on("data",function(a,b,m,e,f){if(!c.b){var d=l([a,b]);var A=c.f.get(d);y(m,A)&&(m=c.i.get(d))&&(m.feed(f),m.have_more_data()&&(f=m.get_data(),c.fire("data",a,b,e,f)))}}).on("encrypt",
function(a){var d;if(!c.b){var b=a.address;var e=a.segment_id;var f=a.target_address;var g=a.plaintext;b=l([b,e]);(f=null!=(d=c.c.get(b))?d.get(f):void 0)&&f.ready()&&(a.ciphertext=f.encrypt(g))}}).on("decrypt",function(a){var b;if(!c.b){var d=a.address;var e=a.segment_id;var f=a.target_address;var g=a.ciphertext;d=l([d,e]);if((e=null!=(b=c.c.get(d))?b.get(f):void 0)&&e.ready())try{a.plaintext=e.decrypt(g)}catch(n){e.destroy(),c.c.get(d)["delete"](f)}}}).on("wrap",function(a){var b,d;if(!c.b){var e=
a.address;var f=a.segment_id;var g=a.target_address;var n=a.unwrapped;e=l([e,f]);(g=null!=(b=c.h.get(e))?null!=(d=b.get(g))?d[0]:void 0:void 0)&&(a.wrapped=g.wrap(n))}}).on("unwrap",function(a){var b,d;if(!c.b){var e=a.address;var f=a.segment_id;var g=a.target_address;var n=a.wrapped;e=l([e,f]);(g=null!=(b=c.h.get(e))?null!=(d=b.get(g))?d[1]:void 0:void 0)&&(a.unwrapped=g.unwrap(n))}})}var y=t.are_arrays_equal;var l=t.concat_arrays;var k=t.ArrayMap;var C=t.timeoutSet;var v=p.MAX_DATA_SIZE;h.prototype=
{process_packet:function(b,a){this.b||this.a.process_packet(b,a)},construct_routing_path:function(b){var a=this;if(this.b)return Promise.reject();b=b.slice();return new Promise(function(u,c){function d(c,m,h){function k(){function d(b,c,f){if(y(e,b)&&y(r,c))if(a.a.off("extend_response",d),clearTimeout(A),f.length){try{w.put_handshake_message(f)}catch(I){n();return}w.ready()?(g.set(l,w.get_rewrapper_keys().map(q.Rewrapper)),a.a.confirm_extended_path(e,r),k()):n()}else n()}var c;b.length?(a.a.on("extend_response",
d),l=b.shift(),(c=q.convert_public_key(l))?(w=q.Encryptor(!0,c),f.set(l,w),A=C(a.o,function(){a.a.off("extend_response",d);n()}),a.a.extend_request(e,r,l,w.get_handshake_message())):n()):(a.m.set(x,[e,r]),u(r))}var l,w,A;if(y(e,c)&&y(r,m)){clearTimeout(t);a.a.off("create_response",d);try{p.put_handshake_message(h)}catch(H){n();return}p.ready()?(g.set(e,p.get_rewrapper_keys().map(q.Rewrapper)),a.a.confirm_outgoing_segment_established(e,r),a.j.set(x,z.Multiplexer(v,a.g)),a.i.set(x,z.Demultiplexer(v,
a.g)),k()):n()}}var h;var m=b[b.length-1];var e=b.shift();var f=k();var g=k();var n=function(){a.l(e,r);c("Routing path creation failed")};if(h=q.convert_public_key(e)){var p=q.Encryptor(!0,h);f.set(e,p);a.a.on("create_response",d);var t=C(a.o,function(){a.a.off("create_response",d);n()});var r=a.a.create_request(e,p.get_handshake_message());var x=l([e,r]);a.c.set(x,f);a.h.set(x,g);a.f.set(x,m)}else n()})},destroy_routing_path:function(b,a){this.l(b,a)},get_max_packet_data_size:function(){return this.g},
send_data:function(b,a,h,c){if(!(this.b||c.length>v)){var d=l([b,a]);var k=this.f.get(d);if(d=this.j.get(d))for(d.feed(c);d.have_more_blocks();)c=d.get_block(),this.a.data(b,a,k,h,c)}},destroy:function(){var b=this;this.b||(this.b=!0,this.m.forEach(function(a){b.l(a[0],a[1])}))},l:function(b,a){b=l([b,a]);if(a=this.c.get(b))a.forEach(function(a){a.destroy()}),this.c["delete"](b),this.h["delete"](b),this.f["delete"](b),this.j["delete"](b),this.i["delete"](b),this.m["delete"](b)}};h.prototype=Object.assign(Object.create(B.prototype),
h.prototype);Object.defineProperty(h.prototype,"constructor",{value:h});return{ready:q.ready,Router:h,MAX_DATA_SIZE:v}}var F=32;var G=16;var E=509;"function"===typeof define&&define.amd?define("@detox/crypto @detox/transport @detox/utils ronion fixed-size-multiplexer async-eventer".split(" "),p):"object"===typeof exports?module.exports=p(require("@detox/crypto"),require("@detox/transport"),require("@detox/utils"),require("ronion"),require("fixed-size-multiplexer"),require("async-eventer")):this.detox_transport=
p(this.detox_crypto,this.detox_transport,this.detox_utils,this.ronion,this.fixed_size_multiplexer,this.async_eventer)}).call(this);